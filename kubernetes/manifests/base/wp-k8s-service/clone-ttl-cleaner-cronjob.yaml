apiVersion: batch/v1
kind: CronJob
metadata:
  name: clone-ttl-cleaner
  namespace: wordpress-staging
  labels:
    app: clone-cleaner
spec:
  # Run every 5 minutes to check for expired clones
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: clone-cleaner
          restartPolicy: Never
          containers:
          - name: cleaner
            # Use wp-k8s-service image which has Python + kubernetes library
            image: 044514005641.dkr.ecr.us-east-1.amazonaws.com/wp-k8s-service:20260220-173000-fix
            command:
            - python3
            - -c
            - |
              import os, time
              from datetime import datetime
              from kubernetes import client, config
              
              config.load_incluster_config()
              apps_api = client.AppsV1Api()
              core_api = client.CoreV1Api()
              networking_api = client.NetworkingV1Api()
              
              namespace = "wordpress-staging"
              now = int(time.time())
              deleted_count = 0
              
              print(f"Starting TTL cleanup at {datetime.now()}")
              print(f"Current timestamp: {now}")
              
              deployments = apps_api.list_namespaced_deployment(
                  namespace=namespace,
                  label_selector="ttl-expires-at"
              )
              
              for deployment in deployments.items:
                  name = deployment.metadata.name
                  ttl_label = deployment.metadata.labels.get("ttl-expires-at")
                  
                  if not ttl_label:
                      continue
                  
                  try:
                      ttl_timestamp = int(ttl_label)
                  except ValueError:
                      print(f"Invalid TTL for {name}: {ttl_label}")
                      continue
                  
                  print(f"Checking: {name} (TTL: {ttl_timestamp})")
                  
                  if ttl_timestamp < now:
                      print(f"  EXPIRED! Deleting {name}")
                      
                      apps_api.delete_namespaced_deployment(name=name, namespace=namespace, body=client.V1DeleteOptions(grace_period_seconds=0))
                      
                      try:
                          core_api.delete_namespaced_service(name=name, namespace=namespace, body=client.V1DeleteOptions(grace_period_seconds=0))
                      except: pass
                      
                      try:
                          networking_api.delete_namespaced_ingress(name=name, namespace=namespace, body=client.V1DeleteOptions(grace_period_seconds=0))
                      except: pass
                      
                      try:
                          core_api.delete_namespaced_secret(name=f"{name}-credentials", namespace=namespace, body=client.V1DeleteOptions(grace_period_seconds=0))
                      except: pass
                      
                      print(f"  Deleted {name}")
                      deleted_count += 1
                  else:
                      remaining = (ttl_timestamp - now) // 60
                      print(f"  Valid ({remaining}min remaining)")
              
              print(f"\nCleanup complete. Deleted: {deleted_count}")
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 100m
                memory: 128Mi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: clone-cleaner
  namespace: wordpress-staging
  labels:
    app: clone-cleaner
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: clone-cleaner
  namespace: wordpress-staging
  labels:
    app: clone-cleaner
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "delete"]
- apiGroups: [""]
  resources: ["services", "secrets"]
  verbs: ["get", "list", "delete"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: clone-cleaner
  namespace: wordpress-staging
  labels:
    app: clone-cleaner
subjects:
- kind: ServiceAccount
  name: clone-cleaner
  namespace: wordpress-staging
roleRef:
  kind: Role
  name: clone-cleaner
  apiGroup: rbac.authorization.k8s.io
